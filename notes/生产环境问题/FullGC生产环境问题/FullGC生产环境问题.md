---
typora-copy-images-to: imgs
---



**故障描述：**

前一天发布了新版本，第二天下午发现CPU使用率飙升，并且接口失败率也升高，并且是一个逐渐崩溃的过程。

服务是一个核心的基础服务，20个节点，崩溃的过程中，服务没有完全当即，失败率大概为70%



**应急措施：**

先将代码回滚



**问题分析：**

cpu使用率飙升说明在进行着一些计算密集型的任务，服务是逐渐崩溃的，那么大概率是应用节点出现了问题，如果是共享资源出现问题，如数据库的话，那么整个服务会直接崩溃，此时去查看JVM相关监控（JVM监控使用Grafana），发现确实发生了Full GC，切Full GC停顿时间持续了五六秒。

这个问题与前一天发布的版本有关，加入了新功能：提供rpc接口，通过上层传递的参数，将数据写入底层的一张表

代码实现流程为：通过一个异步线程池写入，核心线程数设置为1，最大线程也就5个线程进行执行，阻塞队列设置为100，插入数据使用了batch insert，在batch insert之前做了业务处理，导致batch insert的行数很大，出现了`慢SQL`，线程池的队列长度逐渐增大，且队列中有大对象的引用，随着队列长度增大，老年代也放不下了，就发生了Full GC



绕过了TPS限流和上流的熔断，这是因为一整天的QPS比较稳定，并且使用了异步线程池，对他来说RT（最大响应时间）也没有增加，只是阻塞队列中的参数大小发生了变化（有大对象，占用空间）



预防方案：使用慢SQL监控，更早发现问题

